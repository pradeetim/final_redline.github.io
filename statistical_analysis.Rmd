---
title: "Statistical Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(ggplot2)
library(modelr)

SNAP = 
  read_csv(file = "./Datasets/ACS_SNAP_ENROLLMENT.csv")|>
  janitor::clean_names()|>
  select(
    geo_id:s2201_c01_001e,
    s2201_c02_002e,
    s2201_c02_009e,
    s2201_c02_015e,
    s2201_c02_021e:s2201_c02_028e,
    s2201_c02_032e,
    s2201_c02_036e:s2201_c02_038e,
    s2201_c04_001e)|>
  select(-ends_with("m"))|>
  slice(-1)|>
  mutate(geoid = str_remove(geo_id, ".*US"))|>
  rename(
     total_ct_households = s2201_c01_001e,
     ph_elderly = s2201_c02_002e,
     ph_with_children = s2201_c02_009e,
     ph_no_children = s2201_c02_015e,
     ph_below_poverty = s2201_c02_021e,
     ph_above_poverty = s2201_c02_022e,
     ph_disability = s2201_c02_023e,
     ph_no_disability = s2201_c02_024e,
     ph_white = s2201_c02_025e,
     ph_black = s2201_c02_026e,
     ph_asian = s2201_c02_028e,
     ph_hispanic = s2201_c02_032e,
     ph_no_work = s2201_c02_036e,
     ph_1_work = s2201_c02_037e,
     ph_2_work = s2201_c02_038e,
     ph_snap = s2201_c04_001e
  )|>
  mutate(across(total_ct_households:ph_snap, as.numeric),
         ph_other_race = 100-ph_white-ph_black-ph_asian,
         ph_non_hispanic = 100-ph_hispanic)|>
  select(geoid,name,ph_snap,everything())|>
  select(-geo_id)

redlining = 
  read_excel("./Datasets/Historic Redlining Score 2020B.xlsx")|>
  janitor::clean_names()|>
  select(-cbsa)|>
  mutate(fip = substr(geoid20, 1, 5),
         interval2020 = as.character(interval2020),
         red_grade = case_when(
           hrs2020 < 1.5 ~ "A",
           hrs2020 < 2.5 ~ "B",
           hrs2020 < 3.5 ~ "C",
           TRUE ~ "D"
         ))|>
  filter(fip %in% c("36005", "36047", "36061", "36081", "36085"))|>
  rename(geoid = geoid20)

redlining_snap = 
  redlining|>
  left_join(SNAP, by = "geoid")|>
  filter(is.na(ph_snap)==FALSE)

place_crude =
  read_csv("./Datasets/PLACES.csv")|>
  janitor::clean_names()|>
  rename(geoid = location_id)|>
  select(geoid, measure:data_value, measure_id)


place_cleaned=
  place_crude|>
  filter(measure_id %in% c("DIABETES", "HIGHCHOL", "OBESITY"))|>
  pivot_wider(
    id_cols = geoid,
    names_from = measure_id,
    values_from = data_value
  )|>
  janitor::clean_names()|>
  mutate(geoid = as.character(geoid))

# match place data with redlining_snap 
final_analysis = 
  redlining_snap|>
  left_join(place_cleaned, by = "geoid")|>
  filter(!is.na(obesity))|>
  mutate(
    minority = 100-ph_white
  )
```


## Desciptive Characteristics Based on Redlining Grades

### Total count of census tract for each HOLC grade

```{r}
final_analysis |>
  group_by(red_grade)|>
  summarise(count = n())|>
   knitr::kable()
```

The number of A-grade census tract is the smallest (n=36) while the number of C-grade census tract is the biggest(n=1003). 

### Comparison of HOLC grades 

```{r}
redlining_grades=
final_analysis |>
  group_by(red_grade) |>
  summarise(
    avg_snap = mean(ph_snap, na.rm = TRUE),
    sd_snap = sd(ph_snap, na.rm = TRUE),
    avg_elderly = mean(ph_elderly,na.rm=TRUE),
    sd_elderly = sd(ph_elderly, na.rm = TRUE),
    avg_child = mean(ph_with_children, na.rm = TRUE),
    sd_child = sd(ph_with_children, na.rm = TRUE),
    avg_poverty = mean(ph_below_poverty, na.rm = TRUE),
    sd_poverty = sd(ph_below_poverty, na.rm = TRUE),
    avg_disability = mean(ph_disability, na.rm = TRUE),
    sd_disability = sd(ph_disability, na.rm = TRUE),
    avg_white = mean(ph_white, na.rm = TRUE),
    sd_white = sd(ph_white, na.rm = TRUE),
    avg_black = mean(ph_black, na.rm = TRUE),
    sd_black = sd(ph_black, na.rm = TRUE),
    avg_asian = mean(ph_asian, na.rm = TRUE),
    sd_asian = sd(ph_asian, na.rm = TRUE),
    avg_otherrace = mean(ph_other_race, na.rm = TRUE),
    sd_otherrace = sd(ph_other_race, na.rm = TRUE),
    avg_hispanic = mean(ph_hispanic, na.rm = TRUE),
    sd_hispanic = sd(ph_hispanic, na.rm = TRUE),
    avg_nowork = mean(ph_no_work, na.rm = TRUE),
    sd_nowork = sd(ph_no_work, na.rm = TRUE),
    avg_1work = mean(ph_1_work, na.rm = TRUE),
    sd_1work = sd(ph_1_work, na.rm = TRUE),
    avg_2work = mean(ph_2_work, na.rm = TRUE),
    sd_2work = sd(ph_2_work, na.rm = TRUE),
    avg_obesity = mean(obesity, na.rm = TRUE),
    sd_obesity = sd(obesity, na.rm = TRUE),
    avg_highchol = mean(highchol, na.rm = TRUE),
    sd_highchol = sd(highchol, na.rm = TRUE),
    avg_diabetes = mean(diabetes, na.rm = TRUE),
    sd_diabetes = sd(diabetes, na.rm = TRUE)
  )|> pivot_longer(
    cols = -red_grade,
    names_to = c("stat", "variable"),
    names_sep = "_"
  )|>
  pivot_wider(
    names_from = c(red_grade, stat), 
    values_from = value,              
    names_glue = "{red_grade}_{stat}"
  )

anova = function(dataset, outcomes, predictor) {
  results = list() 
  for (outcome in outcomes) {
    formula = as.formula(paste(outcome, "~", factor(predictor)))
    model= aov(
      formula,
      data = dataset
    )
    results[[outcome]] = broom::tidy(model)
  }
  
  combined_results = bind_rows(results, .id = "outcome")
  return(combined_results)
}

outcomes = c("ph_snap","ph_with_children", "ph_elderly","ph_below_poverty", "ph_disability", "ph_white", "ph_black", "ph_asian", "ph_other_race", "ph_hispanic", "ph_no_work","ph_1_work", "ph_2_work", "obesity", "highchol", "diabetes")

baseline_char = 
anova(final_analysis, outcomes, "red_grade")|>
  filter(term == "red_grade")|>
  rename(variable = outcome)|>
  mutate(variable = case_when(
    variable == "ph_snap" ~ "snap",
    variable == "ph_with_children" ~ "child",
    variable == "ph_elderly" ~ "elderly",
    variable == "ph_below_poverty" ~ "poverty",
    variable == "ph_no_work" ~ "nowork",
    variable == "ph_white" ~ "white",
    variable == "ph_black" ~ "black",
    variable == "ph_asian" ~ "asian",
    variable == "ph_other_race" ~ "otherrace",
    variable == "ph_disability" ~ "disability",
    variable == "ph_hispanic" ~ "hispanic",
    TRUE ~ variable
  ))|>
  inner_join(redlining_grades, by="variable")|>
  select(variable, A_avg:D_sd,  p.value)


baseline_char|>
  filter(!variable %in% c("obesity","diabetes","highchol"))|>
  knitr::kable(digits = 3)
```

We computed the average and standard deviation of the different socio-demographic factors across the redlining grade groups. ANOVA was utilized to compare the mean across different census tract grades (A, B, C and D). The percentage of household enrolled in snap/ food stamp program at the census tract level was significantly different among groups with different redlining grades at 5% significance level. A-grade census tracts had the lowest average percentage of SNAP enrollment (5.72%, sd: 6.95%) and the average percentage of SNAP enrollment is the highest in D-grade census tracts (23.70, sd: 17.85). In addition, the groups with different redlining grades reported significant different for the average percentage regarding households with children smaller than 18 years, households with elderly grater than 60 years, households below the poverty line, households with people with disability, race and ethnicity, and employment status. 


### Comparing census tracts with HRS for Grade A with Grade D

```{r warning=FALSE, message=FALSE}
q1_vs_q4 = 
final_analysis|>
  filter(red_grade %in%c("A","D"))|>
  mutate()

q1q4_desc = 
q1_vs_q4|>
  group_by(red_grade)|>
  summarise(
    ph_snap = mean(ph_snap),
    ph_with_children = mean(ph_with_children),
    ph_elderly = mean(ph_elderly),
    ph_below_poverty = mean(ph_below_poverty),
    ph_disability = mean(ph_disability),
    minority = mean(minority),
    ph_no_work = mean(ph_no_work),
    obesity = mean(obesity),
    highchol = mean(highchol),
    diabetes = mean(diabetes)
  )|>
 pivot_longer(cols = -red_grade, names_to = "variable", values_to = "value")|>
 pivot_wider(names_from = red_grade, names_prefix = "grade_", values_from = value)|>
 mutate(
    mean_diff = grade_D - grade_A,
  )|>
  rename(outcome = variable)
```


```{r }
uni_reg = function(dataset, outcomes, predictor) {
  results = list() 
  for (outcome in outcomes) {
    formula = as.formula(paste(outcome, "~", predictor))
    model= t.test(
      formula,
      data = dataset
    )
    results[[outcome]] = broom::tidy(model)
  }
  
  combined_results = bind_rows(results, .id = "outcome")
  return(combined_results)
}

outcomes = c("ph_snap","ph_with_children", "ph_elderly","ph_below_poverty", "ph_disability", "ph_white", "ph_black", "ph_asian", "ph_no_work", "obesity", "highchol", "diabetes")


uni_reg(q1_vs_q4, outcomes, "red_grade")|>
  inner_join(q1q4_desc, by="outcome")|>
  select(outcome, grade_A, grade_D, mean_diff, p.value)|>
  knitr::kable(digits = 3)
```

Following the ANOVA test results, we wondered whether there is any significant difference across the least-redlined (A-grade) and most-redlined (D-grade) census tracts regarding snap enrollment, socio-demographic factors, and health outcomes. Based on the t-test outcome, D-grade census tracts had significantly higher average percentage of households enrolled for SNAP, average percentage of households with children, average percentage of households below the poverty line, average percentage of households with peoplw with diability, percentage of household with minority race compared to A-grade census tracts. Additionally, A-grade census tract had significantly higher average percentage of households with elderly, average percentage of households with no worker.

Regarding the health outcomes, the average prevalence of obesity is 7.97% higher, and the average prevalence for diabetes is 2.34% higher in the D-grade census tracts compared to A-grade census tracts. The average prevalence of high cholesterol level is 4.99% higher in the A-grade census tracts compared to D-grade census tracts. All of the difference in the average prevalence is statistically signficant. 


## Regression Analysis for Redlining and Food Insecurity

Based on the results for the baseline characteristics analysis, we computed a linear regression model to explore the association between redlining grades and precentage of households enrolled in SNAP. 


```{r}
# univariate analysis
lm(ph_snap~red_grade,final_analysis)|>
  broom::tidy()|>
  knitr::kable(digits= 3)
```

Based on the univariate model, we found the percentage of household enrolled in SNAP was 17.97%, 12.90% and 11.53% higher respectively in the D-grade, C-grade and B-grade census tracts compared to A-grade census tracts (all p-value <0.001). 

```{r}
## multivariate model 1
red_snap_m1 = lm(ph_snap~red_grade+minority+ph_elderly+ph_disability+ph_no_work,final_analysis)
tidy_model = broom::tidy(red_snap_m1)
ci = confint(red_snap_m1)

tidy_model|>
  mutate(
    CI_Lower = ci[, 1],
    CI_Upper = ci[, 2],
  )|>
  select(term, estimate, p.value, CI_Lower, CI_Upper)|>
  knitr::kable(digits = 3, caption = "Model 1 Estimates with 95% Confidence Intervals")
```


```{r}
## histogram for snap enrollment
ggplot(final_analysis, aes(x = ph_snap)) +
  geom_histogram(binwidth = 5, fill = "skyblue", color = "black") +
  labs(
    title = "Histogram of ph_snap",
    x = "SNAP Enrollment (ph_snap)",
    y = "Frequency"
  ) +
  theme_minimal()
```


```{r}
## multivariate model 2
red_snap_m2 =
  final_analysis|>
  lm(log(ph_snap+1)~red_grade+minority+ph_elderly+ph_disability+ph_no_work, data=_)

tidy_model = broom::tidy(red_snap_m2)
ci = confint(red_snap_m2)

tidy_model|>
  mutate(
    Back_Transformed_Estimate = exp(estimate),
    CI_Lower = exp(ci[, 1]),
    CI_Upper = exp(ci[, 2]),
    p.value = ifelse(p.value<0.001, "<0.001", p.value)
  )|>
  select(term, estimate, p.value, Back_Transformed_Estimate, CI_Lower, CI_Upper)|>
  knitr::kable(digits = 3, caption = "Model 2 Coefficients with Back-Transformed Estimates and 95% Confidence Intervals")

##multivariate model 3
red_snap_m3 = lm(log(ph_snap+1)~red_grade+ph_white+ph_black+ph_asian+ph_elderly+ph_disability+ph_no_work,final_analysis)

tidy_model = broom::tidy(red_snap_m3)
ci = confint(red_snap_m3)

tidy_model|>
  mutate(
    Back_Transformed_Estimate = exp(estimate),
    CI_Lower = exp(ci[, 1]),
    CI_Upper = exp(ci[, 2]),
    p.value = ifelse(p.value<0.001, "<0.001", p.value)
  )|>
  select(term, estimate, p.value, Back_Transformed_Estimate, CI_Lower, CI_Upper)|>
  knitr::kable(digits = 3, caption = "Model 3 Coefficients with Back-Transformed Estimates and 95% Confidence Intervals")
```




### Cross Validation and Model Selection

```{r}
cv_df =
  crossv_mc(final_analysis, 100)
```


```{r}
cv_df =
cv_df|>
  mutate(model_1 = map(train, \(df)  
                       lm(ph_snap~red_grade+minority+ph_elderly+ph_disability+ph_no_work,
                          data=df)),
         model_2 = map(train, \(df) 
                       lm(log(ph_snap+1)~red_grade+minority+ph_elderly+ph_disability
                          +ph_no_work,data=df)),
         model_3 = map(train, \(df) 
                       lm(log(ph_snap+1)~red_grade+ph_white+ph_black+ph_asian+ph_elderly
                          +ph_disability+ph_no_work, data=df))
           )|>
  mutate(
    rmse_m1 = map2_dbl(model_1, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_m2 = map2_dbl(model_2, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_m3 = map2_dbl(model_3, test, \(mod, df) rmse(model = mod, data = df))
  )
```

```{r}
cv_df |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") |> 
  mutate(model = fct_inorder(model)) |> 
  ggplot(aes(x = model, y = rmse)) + geom_violin()+
  labs(title = "Model 1 vs. Model 2 & 3")+
  theme_minimal()

cv_df |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") |> 
  mutate(model = fct_inorder(model)) |> 
  filter(model == "m2" | model== "m3")|>
  ggplot(aes(x = model, y = rmse)) + geom_violin()+
  labs(title = "Model 2 vs. Model 3")+
  theme_minimal()
```

Based on the rootmean square models, model 2 and 3 perform signficantly better than model 1, while model 3 performs slightly better than model 3. 


## Association of Health Outcomes and Redlining

### Preview the Health Outcomes Data
```{r}
baseline_char|>
  filter(variable %in% c("obesity","diabetes","highchol"))|>
  mutate(p.value = ifelse(p.value<0.001, "<0.001", p.value)) |> 
  knitr::kable(digits = 3)

final_analysis |>
  select(red_grade, obesity, diabetes, highchol) |>
  pivot_longer(cols = c(obesity, diabetes, highchol), 
               names_to = "outcome", 
               values_to = "value") |> 
  ggplot(aes(x = red_grade, y = value, fill = outcome)) +
  geom_boxplot() +
  facet_wrap(~ outcome, scales = "free_y") +
  labs(title = "Boxplot of Health Outcomes by Redlining Grade",
       x = "Redlining Grade",
       y = "Outcome Value")
```

### Linear Models of Obesity, Diabetes and High Cholesterol

```{r}
obesity_model = lm(obesity ~ red_grade, data = final_analysis) 
obesity_model|> 
  broom::tidy()|> 
  mutate(p.value = ifelse(p.value<0.001, "<0.001", p.value)) |> 
  knitr::kable(digits = 3)

diabetes_model = lm(diabetes ~ red_grade, data = final_analysis)
diabetes_model |> 
  broom::tidy()|> 
  knitr::kable(digits = 3)

chol_model = lm(highchol ~ red_grade, data = final_analysis) 
chol_model |> 
  broom::tidy()|> 
  mutate(p.value = ifelse(p.value<0.001, "<0.001", p.value)) |> 
  knitr::kable(digits = 3)
```
```{r}
diabetes_adj_model = lm(log(diabetes)~red_grade+ph_white+ph_black+ph_asian+ph_elderly+ph_disability+ph_no_work,final_analysis)
diabetes_adj_model |> 
  broom::tidy()|> 
  knitr::kable(digits = 3)


obesity_adj_model = lm(log(obesity)~red_grade+ph_white+ph_black+ph_asian+ph_elderly+ph_disability+ph_no_work,final_analysis)
obesity_adj_model |> 
  broom::tidy()|> 
  knitr::kable(digits = 3)

obesity_adj_model = lm(log(highchol)~red_grade+ph_white+ph_black+ph_asian+ph_elderly+ph_disability+ph_no_work,final_analysis)
obesity_adj_model |> 
  broom::tidy()|> 
  knitr::kable(digits = 3)
```

