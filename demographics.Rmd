---
title: "Code Red: Unpacking Inequality"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, echo=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(plotly)
```

```{r datacleaning, echo=FALSE, message=FALSE}
rmarkdown::render("data_cleaning.rmd")
```

```{r setup2, echo=FALSE, message=FALSE}
# Mapping set up
# Load the packages
library(sf)
library(leaflet)
library(tidycensus)

# Set your Census API key
census_api_key("f7b3e47cd8e0fdf7f504751ffad10825be7a5ccf")
install = TRUE
# Get NYC census tract geometries
nyc_tracts <- get_acs(
  geography = "tract",
  variables = "B19013_001",  # Median household income as an example (this is just to pull the geometry)
  state = "NY",
  county = c("Bronx", "Kings", "New York", "Queens", "Richmond"),
  geometry = TRUE,
  year = 2020
) |>
  st_transform(crs = 4326)  # Transform to WGS84 for compatibility with Leaflet

# Extract borough names based on the NAME column
nyc_tracts <- nyc_tracts |>
  mutate(borough = case_when(
    str_detect(NAME, "Bronx County") ~ "Bronx",
    str_detect(NAME, "Kings County") ~ "Brooklyn",
    str_detect(NAME, "New York County") ~ "Manhattan",
    str_detect(NAME, "Queens County") ~ "Queens",
    str_detect(NAME, "Richmond County") ~ "Staten Island",
    TRUE ~ "Unknown"  # This is a fallback in case there are other values
  ))

# Preview the structure of the object
head(nyc_tracts)

```

```{r}
# Rename GEOID to geoid
nyc_tracts <- nyc_tracts |>
  rename(geoid = GEOID)
# Join redlining data with census tract geometries
redlining_sf <- 
  nyc_tracts |>
  left_join(redlining_snap, by = "geoid")

```


### Redlining throughout Boroughs:

```{r}
# Load required library for spatial aggregation
library(dplyr)

# Aggregate the census tract data to get borough-level geometries
borough_boundaries <- nyc_tracts |>
  group_by(borough) |>
  summarize(geometry = st_union(geometry), .groups = 'drop')

# Create a color palette for the hrs2020 variable (continuous scale)
pal <- colorNumeric(
  palette = "YlOrRd",  # Yellow-Orange-Red palette for a gradient effect
  domain = redlining_sf$hrs2020,  # Define the domain using the hrs2020 variable
  na.color = "grey"  # Use grey for NA values
)

# Plot the map focusing on redlining scores (`hrs2020`) throughout the boroughs
leaflet(redlining_sf) |>
  addTiles() |>
  addPolygons(
    fillColor = ~pal(hrs2020),
    weight = 1,
    opacity = 1,
    color = "black",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    ),
    label = ~paste0("Census Tract: ", geoid, 
                    "<br>Borough: ", borough, 
                    "<br>Redlining Score (2020): ", hrs2020)
  ) |>
  addPolygons(
    data = borough_boundaries,
    weight = 3,
    color = "black",
    fill = FALSE,
    opacity = 1,
    highlightOptions = highlightOptions(
      weight = 5,
      color = "#000000",
      bringToFront = TRUE
    )
  ) |>
  addLabelOnlyMarkers(
    data = st_centroid(borough_boundaries),
    lng = ~st_coordinates(geometry)[,1],
    lat = ~st_coordinates(geometry)[,2],
    label = ~borough,
    labelOptions = labelOptions(
      noHide = TRUE,
      direction = 'center',
      textOnly = TRUE,
      style = list("color" = "black", "font-size" = "16px", "font-weight" = "bold")
    )
  ) |>
  addLegend(
    pal = pal,
    values = ~hrs2020,
    opacity = 0.7,
    title = "Redlining Score (2020)",
    position = "bottomright"
  )

```

#### Average Redlining score in each borough.

### SNAP Enrollment Count throughout Boroughs:

#### SNAP Enrollment Demographics

### Grocery Stores in Manhattan, Brooklyn, and Bronx.
```{r}

# Create the map to plot all grocery stores in Manhattan, Brooklyn, and Bronx
leaflet() |>
  addTiles() |>
  addCircleMarkers(
    data = nyc_healthy_store,
    lng = ~longitude,
    lat = ~latitude,
    radius = 5,
    color = "blue",
    stroke = FALSE,
    fillOpacity = 0.8,
    label = ~paste0("Store Name: ", store_name,
                    "<br>Borough: ", borough,
                    "<br>ZIP Code: ", zip_code),
    labelOptions = labelOptions(
      noHide = FALSE,
      direction = "auto"
    )
  ) |>
  addLegend(
    position = "bottomright",
    colors = "blue",
    labels = "Grocery Store",
    title = "Healthy Grocery Stores"
  )

```

### Redlining Scores and Demographics:

```{r}
# Create a color palette for the interval2020 variable
pal <- colorFactor(
  palette = c("green", "blue", "yellow", "red"),
  domain = redlining_sf$interval2020
)

# Plot redlining data on a leaflet map
leaflet(redlining_sf) |>
  addTiles() |>
  addPolygons(
    fillColor = ~pal(interval2020),
    weight = 1,
    opacity = 1,
    color = "black",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    ),
    label = ~paste0("Census Tract: ", geoid, "<br>Redlining Interval: ", interval2020, "<br>Redlining Score (2020): ", hrs2020)
  ) |>
  addLegend(
    pal = pal,
    values = ~interval2020,
    opacity = 0.7,
    title = "Redlining Category",
    position = "bottomright"
  )
```

### Redlining Scores and SNAP Enrollment.

### Redlining Scores and Grocery Stores.


