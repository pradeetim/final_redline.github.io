---
title: "Code Red: Unpacking Inequality"
output: 
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(plotly)
library(stringr)
```

```{r datacleaning, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
rmarkdown::render("data_cleaning.rmd", quiet = TRUE)
```

```{r setup2, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# Mapping set up
# Load the packages
library(sf)
library(leaflet)
library(tidycensus)

census_api_key("f7b3e47cd8e0fdf7f504751ffad10825be7a5ccf")
install = TRUE
nyc_tracts <- get_acs(
  geography = "tract",
  variables = "B19013_001",  # Median household income as an example (this is just to pull the geometry)
  state = "NY",
  county = c("Bronx", "Kings", "New York", "Queens", "Richmond"),
  geometry = TRUE,
  year = 2020
) |>
  st_transform(crs = 4326)  # Transform to WGS84 for compatibility with Leaflet

nyc_tracts <- nyc_tracts |>
  mutate(borough = case_when(
    str_detect(NAME, "Bronx County") ~ "Bronx",
    str_detect(NAME, "Kings County") ~ "Brooklyn",
    str_detect(NAME, "New York County") ~ "Manhattan",
    str_detect(NAME, "Queens County") ~ "Queens",
    str_detect(NAME, "Richmond County") ~ "Staten Island",
    TRUE ~ "Unknown"  # This is a fallback in case there are other values
  ))

head(nyc_tracts)

```

```{r, echo=FALSE, warning=FALSE}
nyc_tracts = nyc_tracts |>
  rename(geoid = GEOID)

redlining_sf = 
  nyc_tracts |>
  left_join(redlining_snap, by = "geoid")

```

## Redlining Exploration:


## Redlining Exploration:
Here is the map detailing the redlining grades given to areas in NYC. There are areas that our data set does not have information for, which are colored grey.

```{r, echo=FALSE, warning=FALSE}

pal <- colorFactor(
  palette = c("#00FF00",  
              "#FFFF00", 
              "#800080", 
              "#FF0000"),
  domain = redlining_sf$red_grade
)

leaflet(redlining_sf) |>
  addProviderTiles(providers$CartoDB.Positron) |> 
  addPolygons(
    fillColor = ~pal(red_grade),
    weight = 1,
    opacity = 1,
    color = "black",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    ),
    label = ~paste0("Census Tract: ", geoid, "<br>Redlining Interval: ", interval2020, "<br>Redlining Score (2020): ", hrs2020)
  ) |>
  addLegend(
    pal = pal,
    values = ~red_grade,
    opacity = 0.7,
    title = "Redlining Category",
    position = "bottomright"
  )

```


### Average Redlining Score in Each Boroughï¼ˆ-delete):

Lets look at the average redlining score in each borough: 

```{r, echo=FALSE, warning=FALSE, fig.align='center'}
redlining = redlining |>
  mutate(
    borough = case_when(
      fip == 36061 ~ "Manhattan",
      fip == 36047 ~ "Brooklyn",
      fip == 36081 ~ "Queens",
      fip == 36005 ~ "Bronx",
      fip == 36085 ~ "Staten Island",
      TRUE ~ "Unknown")
  )

redlining |>
  group_by(borough) |>
  summarize(avg_redline_score =
              mean(hrs2020, na.rm = TRUE)) |>
  mutate(borough = fct_reorder(borough, avg_redline_score)) |>
  ggplot(aes(x = borough, y = avg_redline_score, fill = borough)) +
  geom_point() +
  labs(
    title = "Average Redlining Score by Borough",
    x = "Borough",
    y = "Average Redlining Score"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```

This graph shows the average redlining scores in each borough. Although it looks fairly different, the range is fairly low, between ~3.06 and ~3.24. This does not give us too much information. Lets look at the distribution: 

### Distribution of Redlining Scores in Boroughs(-add average):

```{r, echo=FALSE, fig.align='center'}
redlining |>
  ggplot(aes(x = borough, y = hrs2020, fill = borough)) +
  geom_violin(trim = FALSE, alpha = 0.7) +
  labs(
    title = "Distribution of Redlining Scores by NYC Borough",
    x = "Borough",
    y = "Redlining Score"
  ) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal()
```

This graph shows more detail. The distribution of the scores are fairly different for the boroughs, which Manhattan having the most distribution and Queens having the smallest.

### Redlining Grade Count by Borough:

```{r, echo=FALSE, fig.align='center'}
redlining |> 
  count(borough, red_grade) |>
  mutate(borough = fct_reorder(borough, n)) |>
  plot_ly(
    x = ~borough, 
    y = ~n, 
    color = ~red_grade, 
    type = "bar", 
    colors = "viridis"
  ) |>
  layout(
    title = "Count of Redlining Grades by Borough",
    xaxis = list(title = "Borough"),
    yaxis = list(title = "Count") 
  )

```

We can see here that Staten Island, Queens, and Bronx have the most C grade in their neighborhood. Manhattan and Brooklyn have the grade D as the most frequent. This is similar to what we saw in the violin plot previously. 

## SNAP Exploration and Demographics:

### SNAP Total Household Count in Boroughs(-change to %):

```{r, echo=FALSE, fig.align='center'}
SNAP = SNAP |>
  separate(
    name,
    into = c("census_tract", "county", "state"),
    sep = "; ",
    fill = "right",
    remove = FALSE
  ) |>
  mutate(
    borough = case_when(
      county == "Queens County" ~ "Queens",
      county == "Bronx County" ~ "Bronx",
      county == "New York County" ~ "Manhattan",
      county == "Kings County" ~ "Brooklyn",
      county == "Richmond County" ~ "Staten Island",
      TRUE ~ "Unknown"
    )
  )

SNAP |>
  group_by(borough) |>
  summarize(
    total_household_count = sum(total_ct_households, na.rm = TRUE)
  ) |>
  filter(borough != "Unknown") |>
  plot_ly(
    x = ~borough, 
    y = ~total_household_count, 
    color = ~borough, 
    type = "bar", 
    colors = "viridis"
  ) |>
  layout(
    title = "Total SNAP-Enrolled Households by Borough in 2022",
    xaxis = list(title = "Borough"),
    yaxis = list(title = "Total Household Count"),
    showlegend = FALSE
  )
```

### Race VS Redlinging Grade:
```{r, echo=FALSE}
redlining_long <- redlining_sf |>
  select(red_grade, ph_white, ph_black, ph_asian, ph_other_race) |>
  pivot_longer(
    cols = c(ph_white, ph_black, ph_asian, ph_other_race),
    names_to = "race_group",
    values_to = "percent_household"
  ) |>
  mutate(race_group = case_when(
    race_group == "ph_white" ~ "White",
    race_group == "ph_black" ~ "Black",
    race_group == "ph_asian" ~ "Asian",
    race_group == "ph_other_race" ~ "Other"
  ))

ggplot(redlining_long, aes(x = red_grade, y = percent_household, fill = race_group)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("White" = "#FFC0CB",   # Pastel Pink for White
                               "Black" = "#FFDDC1",   # Pastel Peach for Black
                               "Asian" = "#BDECB6",   # Pastel Mint Green for Asian
                               "Other" = "#C5A3FF")) + # Pastel Lavender for Other
  theme_minimal() +
  labs(
    title = "Race Distribution (White, Black, Asian, Other) by Redlining Grade",
    x = "Redlining Grade",
    y = "Percentage of Households",
    fill = "Race Group"
  ) +
  theme(
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    plot.title = element_text(size = 14, face = "bold"),
    legend.position = "right"
  )
```


## Healthy Grocery Store Exploration:

### Redlinging Grade VS. Grocery Stores(Manhattan,Brooklyn,and Bronx):

```{r, echo=FALSE}
redlining_sf <- redlining_sf |>
  mutate(
    borough = case_when(
      str_detect(NAME, "Bronx County") ~ "Bronx",
      str_detect(NAME, "Kings County") ~ "Brooklyn",
      str_detect(NAME, "New York County") ~ "Manhattan",
      str_detect(NAME, "Queens County") ~ "Queens",
      str_detect(NAME, "Richmond County") ~ "Staten Island",
      TRUE ~ "Unknown"
    )
  )

pal <- colorFactor(
  palette = c("#00FF00",  
              "#FFFF00", 
              "#800080", 
              "#FF0000"),
  domain = redlining_sf$red_grade
)

leaflet(redlining_sf) |>
  addProviderTiles(providers$CartoDB.Positron) |>  
  addPolygons(
    fillColor = ~pal(red_grade),
    weight = 1,
    opacity = 1,
    color = "black",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    ),
    label = ~paste0("Census Tract: ", geoid, 
                    "<br>Redlining Grade: ", red_grade,
                    "<br>Borough: ", borough)
  ) |>
  addCircleMarkers(
    data = nyc_healthy_store,
    lng = ~longitude,
    lat = ~latitude,
<<<<<<< HEAD
    radius = 5,
    color = "green",
=======
    radius = 2.5,  
    color = "blue",
>>>>>>> cb93c36910dfa3f9b5a43a45b1b915cb992b0f96
    stroke = FALSE,
    fillOpacity = 0.7,
    label = ~paste0("Store Name: ", store_name,
                    "<br>Borough: ", borough,
                    "<br>ZIP Code: ", zip_code),
    labelOptions = labelOptions(
      noHide = FALSE,
      direction = "auto"
    )
  ) |>
  addLegend(
<<<<<<< HEAD
    position = "bottomright",
    colors = "green",
    labels = "Grocery Store",
    title = "Healthy Grocery Stores"
=======
    pal = pal,
    values = ~red_grade,
    opacity = 0.7,
    title = "Redlining Grade",
    position = "bottomright"
  ) |>
  addLegend(
    position = "bottomleft",
    colors = "blue",
    labels = "Healthy Grocery Store",
    title = "Healthy Grocery Stores in NYC"
>>>>>>> cb93c36910dfa3f9b5a43a45b1b915cb992b0f96
  )

```

### Redlinging Grade VS.Grocery Stores in Bronx Only:

```{r, echo=FALSE}
bronx_redlining <- redlining_sf |>
  filter(borough == "Bronx")

bronx_stores <- nyc_healthy_store |>
  filter(borough == "Bronx")

pal <- colorFactor(
  palette = c("#00FF00",  
              "#FFFF00",  
              "#800080", 
              "#FF0000"), 
  domain = bronx_redlining$red_grade
)

leaflet(bronx_redlining) |>
  addProviderTiles(providers$CartoDB.Positron) |>  
  addPolygons(
    fillColor = ~pal(red_grade),
    weight = 1,
    opacity = 1,
    color = "black",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    ),
    label = ~paste0("Census Tract: ", geoid, 
                    "<br>Redlining Grade: ", red_grade,
                    "<br>Borough: ", borough)
  ) |>
  addCircleMarkers(
    data = bronx_stores,
    lng = ~longitude,
    lat = ~latitude,
<<<<<<< HEAD
    radius = 5,
    color = "green",
=======
    radius = 2.5,  
    color = "blue", 
>>>>>>> cb93c36910dfa3f9b5a43a45b1b915cb992b0f96
    stroke = FALSE,
    fillOpacity = 0.8,
    label = ~paste0("Store Name: ", store_name,
                    "<br>Borough: ", borough,
                    "<br>ZIP Code: ", zip_code),
    labelOptions = labelOptions(
      noHide = FALSE,
      direction = "auto"
    )
  ) |>
  addLegend(
<<<<<<< HEAD
    position = "bottomright",
    colors = "green",
    labels = "Grocery Store",
=======
    pal = pal,
    values = ~red_grade,
    opacity = 0.7,
    title = "Redlining Grade",
    position = "bottomright"
  ) |>
  addLegend(
    position = "bottomleft",
    colors = "blue",
    labels = "Healthy Grocery Store",
>>>>>>> cb93c36910dfa3f9b5a43a45b1b915cb992b0f96
    title = "Healthy Grocery Stores in Bronx"
  )

```


## Health Outcome vs Redlining Scores

```{r, echo=FALSE, message=FALSE, fig.align='center'}
health_data =
  place_cleaned |>
  mutate(geoid = as.character(geoid)) |>
  left_join(redlining_snap, by = "geoid") |>
  janitor::clean_names()

health_data |>
  drop_na(red_grade, obesity, diabetes, highchol) |>
  select(red_grade, obesity, diabetes, highchol) |>
  group_by(red_grade) |>
  mutate(
    obesity_rate = mean(obesity, na.rm = FALSE),
    diabetes_rate = mean(diabetes, na.rm = FALSE),
    highcholesterol_rate = mean(highchol, na.rm = FALSE)
  ) |>
  select(red_grade, obesity_rate, diabetes_rate, highcholesterol_rate) |>
  pivot_longer(cols = c(obesity_rate, diabetes_rate, highcholesterol_rate), 
               names_to = "condition", values_to = "rate") |>
  ggplot(aes(x = condition, y = rate, fill = condition)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  facet_wrap(~red_grade) + 
  labs(
    title = "Diabetes, Obesity, and High Cholesterol Rates by Redlining Grade",
    x = "Condition",
    y = "Rate"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("diabetes_rate" = "#1f77b4",
                              "obesity_rate" = "#ff7f0e",  
                              "highcholesterol_rate" = "#2ca02c")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none")

```

The graph compares the relationship between redlining and health outcomes (diabetes, obesity, and high cholesterol) in New York City. The higher redlining scores (A, B) tend to have slightly higher obesity and high cholesterol rates, potentially indicating the complex intersection of socioeconomic status, healthcare access, and environmental factors related to historical redlining.


### SNAP Enrollment and Grocery Stores in Bronx(USE IN SHINY APP IF NEEDED).

<<<<<<< HEAD
### Redlining Scores and Demographics:

```{r, echo=FALSE, fig.align='center'}
pal <- colorFactor(
  palette = c("green", "blue", "yellow", "red"),
  domain = redlining_sf$red_grade
)

leaflet(redlining_sf) |>
  addTiles() |>
  addPolygons(
    fillColor = ~pal(red_grade),
    weight = 1,
    opacity = 1,
    color = "black",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    ),
    label = ~paste0("Census Tract: ", geoid, "<br>Redlining Interval: ", interval2020, "<br>Redlining Score (2020): ", hrs2020)
  ) |>
  addLegend(
    pal = pal,
    values = ~red_grade,
    opacity = 0.7,
    title = "Redlining Category",
    position = "bottomright"
  )
```

### Redlining Scores and SNAP Enrollment.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
borough_snap_map |>
  ggplot(aes(x = hrs2020, y = ph_snap, color = borough)) +
  geom_jitter(alpha = 0.6, size = 2, width = 0.1, height = 1) + 
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "black") +
  facet_wrap(~ borough, scales = "free") +
  labs(
    title = "Correlation Between Redlining Scores and SNAP Enrollment Rates by Borough",
    subtitle = "Analysis of SNAP enrollment rates relative to redlining scores (HRS 2020)",
    x = "Redlining Score (HRS 2020)",
    y = "SNAP Enrollment (%)",
    color = "Borough"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    legend.position = "bottom"
  )

```

### Redlining and Grocery Stores in Bronx

```{r, echo=FALSE, fig.align='center'}
redlining_sf <- redlining_sf |>
  mutate(
    borough = case_when(
      str_detect(NAME, "Bronx County") ~ "Bronx",
      str_detect(NAME, "Kings County") ~ "Brooklyn",
      str_detect(NAME, "New York County") ~ "Manhattan",
      str_detect(NAME, "Queens County") ~ "Queens",
      str_detect(NAME, "Richmond County") ~ "Staten Island",
      TRUE ~ "Unknown"
    )
  )

bronx_redlining <- redlining_sf |>
  filter(borough == "Bronx")

bronx_stores <- nyc_healthy_store |>
  filter(borough == "Bronx")

pal <- colorFactor(
  palette = c("green", "blue", "yellow", "red"),
  domain = bronx_redlining$red_grade
)

leaflet(bronx_redlining) |>
  addTiles() |>
  addPolygons(
    fillColor = ~pal(red_grade),
    weight = 1,
    opacity = 1,
    color = "black",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    ),
    label = ~paste0("Census Tract: ", geoid, 
                    "<br>Redlining Grade: ", red_grade)
  ) |>
  addCircleMarkers(
    data = bronx_stores,
    lng = ~longitude,
    lat = ~latitude,
    radius = 5,
    color = "green",
    stroke = FALSE,
    fillOpacity = 0.7,
    label = ~paste0("Store Name: ", store_name,
                    "<br>Borough: ", borough,
                    "<br>ZIP Code: ", zip_code),
    labelOptions = labelOptions(
      noHide = FALSE,
      direction = "auto"
    )
  ) |>
  addLegend(
    pal = pal,
    values = ~red_grade,
    opacity = 0.7,
    title = "Redlining Grade",
    position = "bottomright"
  ) |>
  addLegend(
    position = "bottomleft",
    colors = "green",
    labels = "Grocery Store",
    title = "Healthy Grocery Stores in Bronx"
  )

```

### SNAP Enrollment and Grocery Stores in Bronx.

```{r, echo=FALSE, fig.align='center'}
bronx_ <- borough_snap_map |>
=======
```{r, echo=FALSE}
bronx_ <- redlining_sf |>
>>>>>>> cb93c36910dfa3f9b5a43a45b1b915cb992b0f96
  filter(borough == "Bronx")

bronx_stores <- nyc_healthy_store |>
  filter(borough == "Bronx")

snap_pal <- colorNumeric(
  palette = "YlGnBu",
  domain = bronx_$ph_snap,
  na.color = "grey"
)

leaflet(bronx_) |>
  addTiles() |>
  addPolygons(
    fillColor = ~snap_pal(ph_snap),
    weight = 1,
    opacity = 1,
    color = "black",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    ),
    label = ~paste0("Census Tract: ", geoid, 
                    "<br>SNAP Enrollment (%): ", round(ph_snap, 2))
  ) |>
  addCircleMarkers(
    data = bronx_stores,
    lng = ~longitude,
    lat = ~latitude,
<<<<<<< HEAD
    radius = 5,
    color = "green",
=======
    radius = 2.5,
    color = "blue",
>>>>>>> cb93c36910dfa3f9b5a43a45b1b915cb992b0f96
    stroke = FALSE,
    fillOpacity = 0.7,
    label = ~paste0("Store Name: ", store_name,
                    "<br>Borough: ", borough,
                    "<br>ZIP Code: ", zip_code),
    labelOptions = labelOptions(
      noHide = FALSE,
      direction = "auto"
    )
  ) |>
  addLegend(
    pal = snap_pal,
    values = ~ph_snap,
    opacity = 0.7,
    title = "SNAP Enrollment (%)",
    position = "bottomright"
  ) |>
  addLegend(
    position = "bottomleft",
    colors = "green",
    labels = "Grocery Store",
    title = "Healthy Grocery Stores in Bronx"
  )

```

